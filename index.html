<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join a Room</title>
    <style>
        #remoteVideo, #localVideo {
            width: 100%;
            height: auto;
        }
        #roomsList {
            list-style-type: none;
            padding: 0;
        }
        #roomsList li {
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        #hangupBtn {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Available Rooms</h1>

    <!-- Rooms List -->
    <ul id="roomsList"></ul>

    <!-- Video Stream Display -->
    <video id="localVideo" autoplay playsinline muted style="display: none;"></video>
    <video id="remoteVideo" autoplay playsinline style="display: none;"></video>

    <!-- Hangup Button -->
    <button id="hangupBtn">Hangup</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        const roomsList = document.getElementById('roomsList');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const hangupBtn = document.getElementById('hangupBtn');
        let localStream;
        let peerConnection;
        let currentRoom = null;

        const servers = {
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        };

        // Listen for available rooms in real-time
        firebase.database().ref('rooms').on('value', (snapshot) => {
            roomsList.innerHTML = '';  // Clear the list
            const rooms = snapshot.val();
            if (rooms) {
                Object.keys(rooms).forEach(roomID => {
                    if (rooms[roomID].status === 'available') {
                        const roomItem = document.createElement('li');
                        roomItem.innerText = `Room ID: ${roomID}`;
                        roomItem.onclick = () => joinRoom(roomID);  // Join room on click
                        roomsList.appendChild(roomItem);
                    }
                });
            }
        });

        // Join a room
        function joinRoom(roomID) {
            currentRoom = roomID;

            // Disable room list to prevent multiple joins
            roomsList.style.display = 'none';
            hangupBtn.style.display = 'block';

            // Start local video stream
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localVideo.style.display = 'block';
                    localVideo.srcObject = stream;
                    localStream = stream;
                    localVideo.muted = true;  // Mute local video playback
                    firebase.database().ref('rooms/' + roomID).update({
                        status: "occupied"
                    });

                    // Initialize WebRTC peer connection
                    peerConnection = new RTCPeerConnection(servers);
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                    // Handle receiving remote stream
                    peerConnection.ontrack = event => {
                        remoteVideo.style.display = 'block';
                        remoteVideo.srcObject = event.streams[0];
                    };

                    // Listen for ICE candidates
                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            firebase.database().ref('rooms/' + roomID + '/iceCandidates').push(JSON.stringify(event.candidate));
                        }
                    };

                    // Listen for remote session description (SDP)
                    firebase.database().ref('rooms/' + roomID + '/sdp').on('value', snapshot => {
                        const sdpData = snapshot.val();
                        if (sdpData && !peerConnection.currentRemoteDescription) {
                            peerConnection.setRemoteDescription(new RTCSessionDescription(sdpData));
                            peerConnection.createAnswer()
                                .then(answer => {
                                    peerConnection.setLocalDescription(answer);
                                    firebase.database().ref('rooms/' + roomID + '/sdp').set(JSON.stringify(answer));
                                });
                        }
                    });

                    // Listen for ICE candidates
                    firebase.database().ref('rooms/' + roomID + '/iceCandidates').on('child_added', snapshot => {
                        const candidateData = snapshot.val();
                        if (candidateData) {
                            const candidate = new RTCIceCandidate(JSON.parse(candidateData));
                            peerConnection.addIceCandidate(candidate);
                        }
                    });

                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                });
        }

        // Hangup button functionality
        hangupBtn.onclick = function() {
            // Remove room from Firebase and disconnect both participants
            if (currentRoom) {
                firebase.database().ref('rooms/' + currentRoom).remove();

                // Stop local video stream
                const stream = localVideo.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                localVideo.style.display = 'none';
                remoteVideo.style.display = 'none';
                hangupBtn.style.display = 'none';
                roomsList.style.display = 'block';  // Show room list again

                // Close WebRTC peer connection
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }

                currentRoom = null;
            }
        };
    </script>
</body>
</html>
