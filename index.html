<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join a Room</title>
    <style>
        #remoteVideo, #localVideo {
            width: 100%;
            height: auto;
        }
        #roomsList {
            list-style-type: none;
            padding: 0;
        }
        #roomsList li {
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        #hangupBtn {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Available Rooms</h1>

    <!-- Rooms List -->
    <ul id="roomsList"></ul>

    <!-- Video Stream Display -->
    <video id="localVideo" autoplay playsinline muted style="display: none;"></video>
    <video id="remoteVideo" autoplay playsinline style="display: none;"></video>

    <!-- Hangup Button -->
    <button id="hangupBtn">Hangup</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1b7InCyJf03f82MBrFCXNd_1lir3nWrQ",
            authDomain: "lil-testing.firebaseapp.com",
            databaseURL: "https://lil-testing-default-rtdb.firebaseio.com",
            projectId: "lil-testing",
            storageBucket: "lil-testing.appspot.com",
            messagingSenderId: "309006701748",
            appId: "1:309006701748:web:2cfa73093e14fbcc2af3e1"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        const roomsList = document.getElementById('roomsList');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const hangupBtn = document.getElementById('hangupBtn');
        let currentRoom = null;

        // Listen for available rooms in real-time
        firebase.database().ref('rooms').on('value', (snapshot) => {
            roomsList.innerHTML = '';  // Clear the list
            const rooms = snapshot.val();
            if (rooms) {
                Object.keys(rooms).forEach(roomID => {
                    if (rooms[roomID].status === 'available') {
                        const roomItem = document.createElement('li');
                        roomItem.innerText = `Room ID: ${roomID}`;
                        roomItem.onclick = () => joinRoom(roomID);  // Join room on click
                        roomsList.appendChild(roomItem);
                    }
                });
            }
        });

        // Join a room
        function joinRoom(roomID) {
            currentRoom = roomID;

            // Disable room list to prevent multiple joins
            roomsList.style.display = 'none';
            hangupBtn.style.display = 'block';

            // Start local video stream
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localVideo.style.display = 'block';
                    localVideo.srcObject = stream;
                    localVideo.muted = true;  // Mute local video playback
                    firebase.database().ref('rooms/' + roomID).update({
                        status: "occupied"
                    });

                    // Placeholder for handling the remote video/audio stream
                    // (In a real app, this is where you'd use WebRTC or a similar technology)
                    // remoteVideo.srcObject = remoteStream; // Example: set remote stream
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                });
        }

        // Hangup button functionality
        hangupBtn.onclick = function() {
            // Remove room from Firebase and disconnect both participants
            if (currentRoom) {
                firebase.database().ref('rooms/' + currentRoom).remove();

                // Stop local video stream
                const stream = localVideo.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                localVideo.style.display = 'none';
                remoteVideo.style.display = 'none';
                hangupBtn.style.display = 'none';
                roomsList.style.display = 'block';  // Show room list again

                currentRoom = null;
            }
        };
    </script>
</body>
</html>
